{% extends "base.html" %}
{% load humanize %}

{% block title %}Uncle Machine Shop - {{ machine.title }}{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen pb-12">
    <!-- Breadcrumb -->
    <div class="bg-white border-b border-gray-200">
        <div class="container mx-auto px-4 lg:px-8 py-4">
            <nav class="flex text-sm text-gray-500 overflow-x-auto whitespace-nowrap">
                <a href="{% url 'index' %}" class="hover:text-black transition">หน้าแรก</a>
                <span class="mx-2">/</span>
                <a href="{% url 'machines' %}" class="hover:text-black transition">เครื่องจักรทั้งหมด</a>
                {% if machine.category %}
                <span class="mx-2">/</span>
                <a href="{% url 'machines' %}?category={{ machine.category.slug }}" class="hover:text-black transition">{{ machine.category.name }}</a>
                {% endif %}
                <span class="mx-2">/</span>
                <span class="text-black font-medium text-ellipsis overflow-hidden">{{ machine.title }}</span>
            </nav>
        </div>
    </div>

    <div class="container mx-auto px-4 lg:px-8 py-8">
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-0 lg:gap-8">
                
                <!-- Helper for sharing logic -->
                {% with machine.covers_images.all as images %}
                
                <!-- Left Column: Images -->
                <div class="lg:col-span-5 p-4 lg:p-6">
                    <!-- Main Image Frame -->
                    <div class="relative overflow-hidden rounded-lg bg-gray-100 mb-4 aspect-square group">
                        <img id="mainImage" 
                             src="{% if images %}{{ images.0.image.url }}{% else %}{{ machine.cover_image.url }}{% endif %}" 
                             alt="{{ machine.title }}" 
                             class="w-full h-full object-contain cursor-zoom-in transition-transform duration-300"
                             onclick="openLightbox()">
                        
                        {% if not machine.is_available %}
                        <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                            <span class="bg-red-600 text-white px-6 py-2 rounded-full font-bold transform -rotate-12 border-2 border-white">
                                สินค้าหมด
                            </span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Thumbnails -->
                    {% if images or machine.cover_image %}
                    <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                        <!-- Cover Image Thumbnail -->
                        <button onclick="switchImage('{{ machine.cover_image.url }}', this)" 
                                class="thumbnail-btn active w-20 h-20 flex-shrink-0 border-2 border-black rounded-md overflow-hidden p-1 bg-white hover:opacity-100 opacity-100 transition">
                            <img src="{{ machine.cover_image.url }}" class="w-full h-full object-cover">
                        </button>
                        
                        <!-- Additional Images -->
                        {% for img in images %}
                        <button onclick="switchImage('{{ img.image.url }}', this)" 
                                class="thumbnail-btn w-20 h-20 flex-shrink-0 border-2 border-transparent rounded-md overflow-hidden p-1 bg-white hover:border-gray-300 opacity-70 hover:opacity-100 transition">
                            <img src="{{ img.image.url }}" class="w-full h-full object-cover">
                        </button>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <!-- Right Column: Product Info -->
                <div class="lg:col-span-7 p-6 lg:p-8 lg:border-l border-gray-100">
                    <h1 class="text-2xl lg:text-3xl font-bold mb-4 leading-tight">{{ machine.title }}</h1>
                    
                    <!-- Meta Info -->
                    <div class="flex flex-wrap items-center gap-4 mb-6 text-sm text-gray-500">
                        {% if machine.category %}
                        <a href="{% url 'machines' %}?category={{ machine.category.slug }}" class="text-indigo-600 hover:underline">
                            {{ machine.category.name }}
                        </a>
                        {% endif %}
                    </div>

                    <!-- Price Section -->
                    <div class="bg-gray-50 p-6 rounded-lg mb-8">
                        <div class="flex items-end gap-3">
                            <!-- <span class="text-gray-400 text-lg line-through">฿{{ machine.price|add:"5000"|intcomma }}</span> -->
                            <span class="text-4xl font-bold text-red-600">฿{{ machine.price|intcomma }}</span>
                            <!-- <span class="bg-red-100 text-red-600 text-xs font-bold px-2 py-1 rounded">ลดราคา</span> -->
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                           <i class="fas fa-shield-alt mr-1"></i> รับประกันสินค้าคุณภาพจาก Uncle Engineer
                        </p>
                    </div>

                    <!-- Short Description -->
                    <div class="mb-8 p-4 border border-blue-50 bg-blue-50/30 rounded-lg">
                        <h3 class="font-semibold mb-2 text-gray-700 flex items-center">
                            <i class="fas fa-info-circle mr-2 text-blue-500"></i>รายละเอียดโดยย่อ
                        </h3>
                        <p class="text-gray-600 text-sm leading-relaxed line-clamp-3">
                            {{ machine.descriptions|striptags }}
                        </p>
                        <button onclick="scrollToDescription()" class="text-blue-600 text-sm font-medium mt-2 hover:underline">
                            ดูรายละเอียดเพิ่มเติม
                        </button>
                    </div>

                    <!-- Actions -->
                    <div class="space-y-6">
                        <!-- Quantity -->
                        <div class="flex items-center gap-6">
                            <span class="text-gray-500 font-medium w-24">จำนวน</span>
                            <div class="flex items-center border border-gray-300 rounded">
                                <button onclick="updateQuantity(-1)" class="w-10 h-10 hover:bg-gray-100 flex items-center justify-center transition border-r text-gray-600">
                                    <i class="fas fa-minus text-xs"></i>
                                </button>
                                <input type="number" id="quantity" value="1" min="1" max="100" class="w-16 h-10 text-center border-none focus:ring-0 appearance-none bg-white">
                                <button onclick="updateQuantity(1)" class="w-10 h-10 hover:bg-gray-100 flex items-center justify-center transition border-l text-gray-600">
                                    <i class="fas fa-plus text-xs"></i>
                                </button>
                            </div>
                            <span class="text-sm text-gray-400">มีสินค้าพร้อมส่ง</span>
                        </div>

                        <!-- Buttons -->
                        <div class="flex flex-col sm:flex-row gap-4 pt-4 border-t border-gray-100">
                            <form action="{% url 'cart_add' machine.id %}" method="post" class="add-to-cart-form flex-1" onsubmit="return submitAddToCart(event)">
                                {% csrf_token %}
                                <input type="hidden" name="quantity" id="formQuantity" value="1">
                                <button type="submit" 
                                        class="w-full h-12 flex items-center justify-center border-2 border-black text-black rounded-lg font-bold hover:bg-gray-50 transition gap-2">
                                    <i class="fas fa-cart-plus"></i>
                                    เพิ่มไปยังรถเข็น
                                </button>
                            </form>
                            
                            <form action="{% url 'cart_add' machine.id %}" method="post" class="flex-1" onsubmit="return submitBuyNow(event)">
                                {% csrf_token %}
                                <input type="hidden" name="quantity" id="formQuantityBuy" value="1">
                                <button type="submit" 
                                        class="w-full h-12 flex items-center justify-center bg-black text-white rounded-lg font-bold hover:bg-gray-800 transition shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                                    ซื้อสินค้าทันที
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                
                {% endwith %}
            </div>
            
            <!-- Description Section -->
            <div id="descriptionSection" class="border-t border-gray-200 mt-8">
                <div class="bg-gray-50 px-8 py-4 border-b border-gray-200">
                     <h2 class="text-lg font-bold">รายละเอียดสินค้า</h2>
                </div>
                <div class="p-8">
                    <div class="prose max-w-none text-gray-700">
                        {{ machine.descriptions|linebreaks }}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Related Products (Can be added later) -->
    </div>
</div>

<style>
    .thumbnail-btn.active {
        border-color: black;
        opacity: 1;
    }
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { 
        -webkit-appearance: none; 
        margin: 0; 
    }
</style>

</script>
{% endblock %}

{% block extra_js %}
<script>
    // --- Persistence Logic ---
    const STORAGE_KEY = 'machine_qty_{{ machine.id }}';

    function loadSavedQuantity() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            const val = parseInt(saved);
            if (!isNaN(val) && val >= 1 && val <= 100) {
                setQuantity(val);
            }
        }
    }

    function saveQuantity(val) {
        localStorage.setItem(STORAGE_KEY, val);
    }

    function setQuantity(val) {
        const input = document.getElementById('quantity');
        if (input) {
            input.value = val;
            // Sync hidden inputs
            const formQty = document.getElementById('formQuantity');
            if (formQty) formQty.value = val;
            
            const formQtyBuy = document.getElementById('formQuantityBuy');
            if (formQtyBuy) formQtyBuy.value = val;
        }
    }

    // --- Image Gallery ---
    function switchImage(url, btn) {
        // Change main image
        const mainImage = document.getElementById('mainImage');
        mainImage.style.opacity = '0.5';
        setTimeout(() => {
            mainImage.src = url;
            mainImage.style.opacity = '1';
        }, 150);

        // Update active class
        document.querySelectorAll('.thumbnail-btn').forEach(b => {
            b.classList.remove('active', 'border-black');
            b.classList.add('border-transparent');
            b.classList.remove('opacity-100');
            b.classList.add('opacity-70');
        });
        
        btn.classList.add('active', 'border-black', 'opacity-100');
        btn.classList.remove('border-transparent', 'opacity-70');
    }

    function openLightbox() {
        // Simple lightbox implementation can be added here
        // For now, just maybe a simple console log or alert as placeholder
        // or functionality to view full screen
    }

    function scrollToDescription() {
        document.getElementById('descriptionSection').scrollIntoView({ behavior: 'smooth' });
    }

    // --- Quantity Logic ---
    function updateQuantity(change) {
        const input = document.getElementById('quantity');
        let newVal = parseInt(input.value) + change;
        if (newVal < 1) newVal = 1;
        if (newVal > 100) newVal = 100; // Max limit
        
        setQuantity(newVal);
        saveQuantity(newVal);
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadSavedQuantity();
        
        const qtyInput = document.getElementById('quantity');
        if (qtyInput) {
            qtyInput.addEventListener('change', function() {
                let val = parseInt(this.value);
                if (val < 1) val = 1;
                this.value = val;
                setQuantity(val);
                saveQuantity(val);
            });
        }
    });

    // --- Cart Logic (Copied and adapted from machines.html) ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `fixed top-24 right-4 px-6 py-4 rounded-lg shadow-xl z-50 transform transition-all duration-300 translate-x-full ${
            type === 'success' ? 'bg-gray-900 text-white' : 'bg-red-500 text-white'
        }`;
        notification.innerHTML = `
            <div class="flex items-center gap-3">
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} text-xl"></i>
                <span class="font-medium">${message}</span>
            </div>
        `;

        document.body.appendChild(notification);
        
        // Trigger reflow
        notification.offsetHeight;

        // Slide in
        notification.style.transform = 'translateX(0)';

        // Remove
        setTimeout(() => {
            notification.style.transform = 'translateX(110%)';
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }

    function updateCartCount(count) {
        const ids = ['desktop-cart-count', 'mobile-cart-count'];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.innerText = count;
                if (count > 0) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            }
        });
    }

    function submitAddToCart(e) {
        e.preventDefault();
        const form = e.target;
        const button = form.querySelector('button');
        const originalContent = button.innerHTML;
        
        // Loading state
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังเพิ่ม...';
        button.classList.add('opacity-75');

        const formData = new FormData(form);
        
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showNotification(data.message);
                button.innerHTML = '<i class="fas fa-check"></i> เพิ่มแล้ว';
                
                // Update cart count
                if (data.cart_count !== undefined) {
                    updateCartCount(data.cart_count);
                }
                
                // Reset button
                setTimeout(() => {
                    button.disabled = false;
                    button.classList.remove('opacity-75');
                    button.innerHTML = originalContent;
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('เกิดข้อผิดพลาด กรุณาลองใหม่', 'error');
            button.disabled = false;
            button.innerHTML = originalContent;
        });

        return false;
    }

    function submitBuyNow(e) {
        // For buy now, we want to submit normally to redirect to cart/checkout
        // But first let's add to cart via AJAX then redirect, OR just let standard form submission happen?
        // Standard submission is better for "Buy Now" flow unless we want to do fancy things.
        // If the backend 'cart_add' view redirects to cart_detail on success, standard submit is fine.
        // Assuming the backend handles direction or we can just let it submit.
        // Let's allow standard submission for "Buy Now" for now.
        return true; 
    }
</script>
{% endblock %}
