{% extends "base.html" %}
{% load humanize %}

{% block title %}MACHINEBKK.COM - เครื่องจักรเครื่องจักร{% endblock %}

{% block content %}
<div class="container mx-auto px-4 lg:px-8 py-8">


    <!-- Filters Section -->
    <div class="mb-6">
        <div class="grid gap-6">

            <!-- Category Filter -->
            <div>
                <div class="flex flex-wrap gap-2">
                    <a href="{% url 'machines' %}{% if search_query %}?search={{ search_query }}{% endif %}"
                       class="category-filter-btn {% if not selected_category %}active{% endif %}">
                        <i class="fas fa-th mr-1"></i>ทั้งหมด
                    </a>
                    {% for category in categories %}
                    <a href="{% url 'machines' %}?category={{ category.slug }}{% if search_query %}&search={{ search_query }}{% endif %}"
                       class="category-filter-btn {% if selected_category and selected_category.slug == category.slug %}active{% endif %}">
                        <i class="fas fa-cog mr-1"></i>{{ category.name }}
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Active Filters -->
        {% if selected_category or search_query %}
        <div class="mt-4 pt-4 border-t border-gray-200">
            <div class="flex items-center gap-2 flex-wrap">
                <span class="text-sm font-medium">ตัวกรองแสดงผล:</span>
                {% if selected_category %}
                <a href="{% url 'machines' %}{% if search_query %}?search={{ search_query }}{% endif %}"
                   class="inline-flex items-center bg-black text-white px-4 py-2 rounded-full text-sm hover:bg-gray-800 transition">
                    {{ selected_category.name }}
                    <i class="fas fa-times ml-2"></i>
                </a>
                {% endif %}
                {% if search_query %}
                <a href="{% url 'machines' %}{% if selected_category %}?category={{ selected_category.slug }}{% endif %}"
                   class="inline-flex items-center bg-black text-white px-4 py-2 rounded-full text-sm hover:bg-gray-800 transition">
                    "{{ search_query }}"
                    <i class="fas fa-times ml-2"></i>
                </a>
                {% endif %}
                <a href="{% url 'machines' %}" class="text-sm text-gray-600 hover:text-black transition">
                    ล้างตัวกรอง
                </a>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Books Grid -->
    {% if all_machines %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        {% for machine in all_machines %}
        <div class="book-card bg-white rounded-2xl overflow-hidden cursor-pointer group transition-all hover:shadow-2xl">
            <!-- Book Cover -->
            <div class="bg-gray-200 relative overflow-hidden">
                {% if machine.cover_image %}
                <img src="{{ machine.cover_image.url }}"
                     alt="{{ machine.title }}"
                     class="w-full h-94 object-cover group-hover:scale-110 transition-transform duration-500"
                     onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'w-full h-full flex items-center justify-center bg-gradient-to-br from-gray-100 to-gray-200\'><i class=\'fas fa-cog text-6xl text-gray-400\'></i></div>';">
                {% else %}
                <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-gray-100 to-gray-200">
                    <i class="fas fa-cog text-6xl text-gray-400"></i>
                </div>
                {% endif %}

                <!-- Category Badge -->
                {% if machine.category %}
                <div class="absolute top-3 left-3 bg-black text-white text-xs font-bold px-3 py-1 rounded-full">
                    {{ machine.category.name }}
                </div>
                {% endif %}

                <!-- Availability Badge -->
                {% if machine.is_available %}
                <div class="absolute top-3 right-3 bg-green-500 text-white text-xs font-bold px-3 py-1 rounded-full">
                    พร้อมดู
                </div>
                {% endif %}

                <!-- Hover Overlay -->
                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-60 transition-all duration-300 flex items-center justify-center opacity-0 group-hover:opacity-100">
                    <a href="{% url 'machine_detail' machine.slug %}" class="bg-white text-black px-6 py-3 rounded-full font-semibold transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300">
                        <i class="fas fa-eye mr-2"></i>ดูรายละเอียด
                    </a>
                </div>
            </div>

            <!-- Book Info -->
            <div class="p-4">
                <h3 class="font-bold text-base mb-2 line-clamp-2 group-hover:text-gray-600 transition min-h-[3rem]">
                    {{ machine.title }}
                </h3>

                {% if machine.descriptions %}
                <p class="text-sm text-gray-600 mb-3 line-clamp-2">
                    {{ machine.descriptions|truncatewords:10 }}
                </p>
                {% endif %}

                <div class="flex items-center justify-between mt-auto">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-cog text-gray-400 text-sm"></i>
                        <span class="text-sm text-gray-600">{{ machine.category.name|default:"เครื่องจักรทั่วไป" }}</span>
                    </div>
                    <div class="font-bold text-indigo-600">฿{{ machine.price|intcomma }}</div>
                </div>

                <a href="{% url 'machine_detail' machine.slug %}" class="mt-3 relative z-20 block w-full bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-black transition text-center">
                    <i class="fas fa-eye mr-2"></i>รายละเอียดเพิ่มเติม
                </a>

                <!-- Additional Images Indicator -->
                {% if machine.covers_images.count > 0 %}
                <div class="mt-3 flex items-center text-xs text-gray-500">
                    <i class="fas fa-images mr-1"></i>
                    <span>+{{ machine.covers_images.count }} รูปภาพ</span>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- No Books Found -->
    <div class="text-center py-20">
        <div class="inline-flex items-center justify-center w-24 h-24 bg-gray-100 rounded-full mb-6">
            <i class="fas fa-cog text-4xl text-gray-400"></i>
        </div>
        <h3 class="text-2xl font-bold mb-2">ยังไม่มีเครื่องจักร</h3>
        <p class="text-gray-600 mb-6">
            {% if search_query %}
             "{{ search_query }}"
            {% elif selected_category %}
            " "{{ selected_category.name }}"
            {% else %}
            กำลังเพิ่มเครื่องจักรใหม่ๆ เร็วๆ นี้
            {% endif %}
        </p>
        <div class="flex justify-center gap-4">
            {% if search_query or selected_category %}
            <a href="{% url 'ebooks' %}" class="inline-flex items-center bg-black text-white px-8 py-3 rounded-full font-semibold hover:bg-gray-800 transition">
                <i class="fas fa-redo mr-2"></i>
                ลองค้นหาใหม่อีกครั้ง
            </a>
            {% endif %}
            <a href="{% url 'categories' %}" class="inline-flex items-center bg-gray-100 text-black px-8 py-3 rounded-full font-semibold hover:bg-gray-200 transition">
                <i class="fas fa-th mr-2"></i>
                ย้อนกลับไปดูหมวดหมู่
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Back to Home -->
    <div class="text-center mt-12">
        <a href="{% url 'index' %}" class="inline-flex items-center justify-center px-8 py-3 bg-gray-100 text-black rounded-full hover:bg-gray-200 transition-all duration-300">
            <i class="fas fa-home mr-2"></i>
            ย้อนกลับ
        </a>
    </div>
</div>

<style>
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .book-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .book-card:hover {
        transform: translateY(-8px);
    }

    .category-filter-btn {
        display: inline-flex;
        align-items: center;
        padding: 0.5rem 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.3s;
        background: white;
        color: #374151;
    }

    .category-filter-btn:hover {
        border-color: #000;
        transform: scale(1.05);
    }

    .category-filter-btn.active {
        background: #000;
        color: white;
        border-color: #000;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .book-card {
        animation: fadeIn 0.5s ease-out;
    }

    /* Stagger animation for cards */
    .book-card:nth-child(1) { animation-delay: 0.05s; }
    .book-card:nth-child(2) { animation-delay: 0.1s; }
    .book-card:nth-child(3) { animation-delay: 0.15s; }
    .book-card:nth-child(4) { animation-delay: 0.2s; }
    .book-card:nth-child(5) { animation-delay: 0.25s; }
    .book-card:nth-child(6) { animation-delay: 0.3s; }
    .book-card:nth-child(7) { animation-delay: 0.35s; }
    .book-card:nth-child(8) { animation-delay: 0.4s; }
    .book-card:nth-child(9) { animation-delay: 0.45s; }
    .book-card:nth-child(10) { animation-delay: 0.5s; }
</style>

{% block extra_js %}
<script>
    // Auto-submit search form on Enter
    const searchInput = document.querySelector('input[name="search"]');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                this.form.submit();
            }
        });
    }

    // Smooth scroll animation observer
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, observerOptions);

    document.querySelectorAll('.book-card').forEach(card => {
        observer.observe(card);
    });

    // AJAX Add to Cart functionality
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Show notification
    function showNotification(message, type = 'success') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 px-6 py-4 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-0 ${
            type === 'success' ? 'bg-black text-white' : 'bg-red-500 text-white'
        }`;
        notification.innerHTML = `
            <div class="flex items-center gap-3">
                <i class="fas fa-check-circle text-xl"></i>
                <span class="font-medium">${message}</span>
            </div>
        `;

        document.body.appendChild(notification);

        // Animate in
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
        }, 10);

        // Remove after 3 seconds
        setTimeout(() => {
            notification.style.transform = 'translateX(400px)';
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }

    // Handle add to cart forms
    document.querySelectorAll('.add-to-cart-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const csrftoken = getCookie('csrftoken');
            const button = this.querySelector('button[type="submit"]');
            const originalText = button.innerHTML;

            // Disable button and show loading
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>กำลังเพิ่ม...';

            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Show success notification
                    showNotification(data.message);

                    // Update button text temporarily
                    button.innerHTML = '<i class="fas fa-check mr-2"></i>เพิ่มแล้ว';

                    // Reset button after 2 seconds
                    setTimeout(() => {
                        button.disabled = false;
                        button.innerHTML = originalText;
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง', 'error');
                button.disabled = false;
                button.innerHTML = originalText;
            });
        });
    });
</script>
{% endblock %}
{% endblock %}
